pipeline {
    agent {
        label 'fonetwish'
    }
    stages {
        stage('Maven Clean Install') {
            when {
		        anyOf {
			        branch 'feature'; branch 'develop'; branch 'main'
		        }
            } 	
            steps {
                powershell 'mvn clean install'
            }
        }
        stage('Build and push Docker Image') {
	        when {
		        anyOf {
			        branch 'develop'; branch 'main'
	            }
            }
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-cred', passwordVariable: 'TOKEN', usernameVariable: 'USERNAME')]) {
                    powershell '''
						$IMAGE="dev-promotion-assessment"
						$NOW=Get-Date -Format "%y%M%d"
						$BUILD="${env:BUILD_NUMBER}"
						$TAG="$($NOW).$($BUILD)"
						$ACR_LOGINSERVER="kabirajdemoacr.azurecr.io"
						docker login ${ACR_LOGINSERVER} --username ${env:USERNAME} --password ${env:TOKEN}
						docker build -t ${IMAGE}:${TAG} .
						docker images
						docker tag ${IMAGE}:${TAG} ${ACR_LOGINSERVER}/${IMAGE}:${TAG}
						docker push ${ACR_LOGINSERVER}/${IMAGE}:${TAG}
					'''
                }
            }
        }
        stage('Deploy to AKS') {
	        when {
		        anyOf {
			        branch 'develop'; branch 'main'
	            }
            }
            steps {
                withCredentials([file(credentialsId: 'kubeconfig-file', variable: 'filepath')]) {
                    powershell '''
						$NOW=Get-Date -Format "%y%M%d"
						$BUILD="${env:BUILD_NUMBER}"
						$TAG="$($NOW).$($BUILD)"
                        		        $env:KUBECONFIG="$filepath"
                                                C:\"Program Files"\Helm\windows-amd64\helm version
                        		        C:\"Program Files"\Helm\windows-amd64\helm upgrade --install pet-clinic pet-clinic --set image.tag=$TAG
					'''
                }
            }
        }
    }
}
